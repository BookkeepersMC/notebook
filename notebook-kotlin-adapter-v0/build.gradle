buildscript {
	repositories {
		mavenCentral()
		gradlePluginPortal()
	}
	dependencies {
		def kotlinVersion = file("generated_files/kotlin_version.txt").text
		classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion"
	}
}

apply plugin: "org.jetbrains.kotlin.jvm"

group = project.group

def ENV = System.getenv()
def LIBRARY_VERSIONS_FILE = "generated_files/library_versions.json"
def KOTLIN_VERSION_FILE = "generated_files/kotlin_version.txt"

def kotlinLib = "org.jetbrains.kotlin:kotlin-stdlib"
def libraries = [
	kotlinLib,
	"org.jetbrains.kotlin:kotlin-stdlib-jdk8",
	"org.jetbrains.kotlin:kotlin-stdlib-jdk7",
	"org.jetbrains.kotlin:kotlin-reflect",

	"org.jetbrains.kotlinx:kotlinx-coroutines-core",
	"org.jetbrains.kotlinx:kotlinx-coroutines-core-jvm",
	"org.jetbrains.kotlinx:kotlinx-coroutines-jdk8",
	"org.jetbrains.kotlinx:kotlinx-serialization-core-jvm",
	"org.jetbrains.kotlinx:kotlinx-serialization-json-jvm",
	"org.jetbrains.kotlinx:kotlinx-serialization-cbor-jvm",
	"org.jetbrains.kotlinx:atomicfu-jvm",
	"org.jetbrains.kotlinx:kotlinx-datetime-jvm",
	"org.jetbrains.kotlinx:kotlinx-io-core-jvm",
	"org.jetbrains.kotlinx:kotlinx-io-bytestring-jvm"
]

def libVersions = new JsonSlurper().parse(file(LIBRARY_VERSIONS_FILE))
def hasMissingLibVersion = !libVersions.keySet().containsAll(libraries)

configurations {
	includeAndExpose

	modApi {
		extendsFrom includeAndExpose
	}
	include {
		extendsFrom includeAndExpose
	}
}

configurations.all {
	resolutionStrategy {
		failOnNonReproducibleResolution()
	}
}

dependencies {
	testImplementation "org.jetbrains.kotlin:kotlin-test"

	if (hasMissingLibVersion) {
		println("Contains missing library version, run updateLibraryVersions task!")
	} else {
		libraries.forEach {
			includeAndExpose("${it}:${libVersions[it]}")
		}
	}
}

import groovy.json.JsonBuilder
import groovy.json.JsonSlurper
import groovy.xml.XmlSlurper
import org.gradle.util.VersionNumber

import java.nio.charset.StandardCharsets

task updateLibraryVersions {
	group = "update"
	doFirst {
		def output = [:]
		def slurper = new XmlSlurper()
		for (def lib : libraries) {
			def split = lib.split(":", 2)
			def group = split[0].replace(".", "/")
			def artifact = split[1]
			def xml = new URL("https://repo1.maven.org/maven2/${group}/${artifact}/maven-metadata.xml").text
			def metadata = slurper.parseText(xml)
			def versions = metadata.versioning.versions.version*.text()

			def latest = versions[0]
			def latestParsed = VersionNumber.parse(latest)
			for (def version : versions) {
				def parsed = VersionNumber.parse(version)
				if (parsed.qualifier == null && parsed > latestParsed) {
					latestParsed = parsed
					latest = version
				}
			}

			println("${lib} = ${latest}")
			output.put(lib, latest)

			if (lib == kotlinLib) {
				file(KOTLIN_VERSION_FILE).setText(latest, StandardCharsets.UTF_8.name())
			}
		}
		def json = new JsonBuilder(output)
		file(LIBRARY_VERSIONS_FILE).setText(json.toPrettyString(), StandardCharsets.UTF_8.name())
	}
}
